<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/course/libs/highlight/styles/github.min.css"> <link href="/course/css/franklin.css" rel=stylesheet > <link href="/course/css/vela.css" rel=stylesheet > <script src="/course/libs/vela/jquery.min.js"></script> <link rel=icon  href="/course/assets/favicon.png"> <title>Neuroblox course</title> <div class="main-nav slideout-menu slideout-menu-left" id=menu > <div class=flex-container > <span class=sidebar-brand > <h3 style='font-size: 25px'>Neuroblox course</h3> </span> </div> <nav class=sidebar-nav > <ul class=metismenu  id=metismenu  > <li><a href="/course/index.html">Home</a> <li><a href="/course/pages/instructions">Instructions</a> <li><a href="/course/pages/intro_julia">Introduction to Julia</a> <li><a href="/course/pages/intro_diffeq">Differential Equations with ModelingToolkit</a> <li><a href="/course/pages/intro_plot">Plotting with Makie</a> <li><a href="/course/pages/custom">Custom Bloxs and Connections</a> <li><a href="/course/pages/neuron_mass">Neurons, Neural Masses and Sources</a> <li><a href="" class=has-arrow >Circuit Models</a> <ul> <li><a href="/course/pages/circuits">Introduction</a> <li><a href="/course/pages/CS_circuit">Biomimetic Corticostriatal assemblies</a> <li><a href="/course/pages/PING_circuit">Pyramidal-Interneuron Gamma network</a> </ul> <li><a href="/course/pages/decision_making">Decision Making</a> <li><a href="/course/pages/learning">Synaptic Plasticity and Reinforcement Learning</a> <li><a href="/course/pages/DCM">Spectral Dynamic Causal Modeling</a> </ul> </nav> </div> <main id=panel  class="slidout-panel slideout-panel-left"> <div class="toggle-button hamburger hamburger--spin"> <div class=hamburger-box > <div class=hamburger-inner ></div> </div> </div> <h1 class="page title">Neurons, Neural Masses and Sources</h1> <hr> <div class=franklin-content ><div class=franklin-toc ><ol><li><a href="#introduction">Introduction</a><li><a href="#neurons_and_neural_masses">Neurons and neural masses</a><li><a href="#sources">Sources</a><ol><li><a href="#continuous_input_sources">Continuous input sources</a><li><a href="#event-based_spike_sources">Event-based spike sources</a><li><a href="#deep_brain_stimulation">Deep Brain Stimulation</a></ol><li><a href="#challenge_problems">Challenge Problems</a><li><a href="#references">References</a></ol></div> <h1 id=neurons_neural_masses_and_sources ><a href="#neurons_neural_masses_and_sources" class=header-anchor >Neurons, Neural Masses and Sources</a></h1> <h2 id=introduction ><a href="#introduction" class=header-anchor >Introduction</a></h2> <p>The main distinction between the neuron, neural mass and source Blox we will encounter on this session is the mechanism by which they communicate with other Bloxs. All neural mass Bloxs, some sources, and neurons of the Hodgkin-Huxley &#40;HH&#41; family have continuous output variables which are included as terms in the postsynaptic Blox&#39;s differential equations. The alternative is an event-based connection. Neurons of the Izhikevich and the Integrate-and-fire families of models operate this way as we have previosuly seen. Sources that simulate spike trains may also operate the same way via callbacks.</p> <p>Learning goals :</p> <ul> <li><p>visualize results from neuron and neural mass Blox simulations</p> <li><p>introduce external sources as Blox</p> <li><p>drive single neuron and neural mass activity using external sources</p> </ul> <h2 id=neurons_and_neural_masses ><a href="#neurons_and_neural_masses" class=header-anchor >Neurons and neural masses</a></h2> <p>As a first example we will consider a neural mass <code>WilsonCowan</code> Blox of Exhitatation-Inhibition &#40;E-I&#41; balance. This is a two-dimensional reduction over a population of excitatory and inhibitory neurons with continuous dynamics.</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Neuroblox
<span class=hljs-keyword >using</span> OrdinaryDiffEq
<span class=hljs-keyword >using</span> CairoMakie

<span class=hljs-meta >@named</span> nm = WilsonCowan()
<span class=hljs-comment ># Retrieve the simplified ODESystem of the Blox</span>
sys = system(nm)
tspan = (<span class=hljs-number >0</span>, <span class=hljs-number >100</span>) <span class=hljs-comment ># ms</span>
prob = ODEProblem(sys, [], tspan)
sol = solve(prob, Tsit5())

fig, ax = plot(sol);
axislegend(ax) <span class=hljs-comment >## add legend to the plot</span>
fig</code></pre> <img src="/course/assets/pages/neuron_mass/code/output/wc_all.svg" alt=""> <p>Using the generic <code>plot</code> function we visualize all states of our model. We can retrieve specific variables by using</p> <pre><code class="julia hljs">E = state_timeseries(nm, sol, <span class=hljs-string >&quot;E&quot;</span>) <span class=hljs-comment >## retrieves state `E` of Blox `nm`</span>
fig = lines(E); <span class=hljs-comment >## simple line plot</span>
fig</code></pre> <img src="/course/assets/pages/neuron_mass/code/output/wc_timeseries.svg" alt=""> <p>Moving on to neurons, we will use a Quadratic Integrate-and-fire &#40;QIF&#41; neuron model with an added callback that increases the input current after 60 ms.</p> <pre><code class="julia hljs"><span class=hljs-meta >@named</span> qif = QIFNeuron(; I_in=<span class=hljs-number >4</span>)
<span class=hljs-comment ># We can pass additional events to be included in the final system.</span>
sys = system(qif; discrete_events = [<span class=hljs-number >60</span>] =&gt; [qif.I_in ~ <span class=hljs-number >10</span>])
tspan = (<span class=hljs-number >0</span>, <span class=hljs-number >100</span>) <span class=hljs-comment ># ms</span>
prob = ODEProblem(sys, [], tspan)
sol = solve(prob, Tsit5())</code></pre><pre><code class="plaintext hljs">retcode: Success
Interpolation: specialized 4th order &quot;free&quot; interpolation
t: 97-element Vector{Float64}:
   0.0
   0.11043012839242242
   0.4831122698374086
   0.9075602575526773
   1.5200686806970882
   2.2328471482119903
   3.179283803135524
   4.296999521538077
   5.680584095552938
   7.284240487553793
   9.02838833611385
  11.473793226400254
  11.473793226400254
  12.325147694053943
  13.025262534767663
  14.23189622072994
  15.349579989603246
  16.951975600712544
  18.623736783785027
  20.54839853617244
  23.153620464848103
  23.153620464848103
  24.00523352505048
  24.736508447312314
  25.94807248547888
  27.10130649992389
  28.718593155120033
  30.422485422145083
  32.34979292412259
  35.028826449084
  35.028826449084
  35.879882485117626
  36.63405149540032
  37.84818204944838
  39.02729274143436
  40.65446272104638
  42.38112653660273
  44.321362189447335
  47.0603967671553
  47.0603967671553
  47.91136256470937
  48.684142843629914
  49.90064862512646
  51.100824220513765
  52.73622923555467
  54.48127541462401
  56.458330064820984
  59.26733368246331
  59.26733368246331
  60.0
  60.0
  60.786973182441045
  61.75397040178183
  62.863520820189066
  64.13690497131789
  65.66666515531641
  65.66666515531641
  66.49504643180266
  67.10218833552359
  68.17870821254759
  69.1526411957066
  70.44236705188233
  71.8978032026054
  71.8978032026054
  72.72287560394192
  73.30837211226053
  74.37412704327069
  75.3252593704334
  76.60200034358238
  78.01539662383894
  78.01539662383894
  78.83780185276147
  79.39719496644298
  80.450784967721
  81.37455167885207
  82.63567571505645
  83.9994914569245
  83.9994914569245
  84.82342910333087
  85.34385107409771
  86.38324814116194
  87.26702706376788
  88.50653471732186
  89.80122626942892
  89.80122626942892
  90.64044163930429
  91.09068413396372
  92.11099925634888
  92.92389024522961
  94.1265071588864
  95.30372865797398
  97.05883292802599
  97.05883292802599
  97.92054460585194
  98.68654122784083
  99.84409031709166
 100.0
u: 97-element Vector{Vector{Float64}}:
 [-70.0, 0.0, 0.0]
 [-64.56634709526935, 0.0, 0.0]
 [-50.82142562689537, 0.0, 0.0]
 [-40.38681631810811, 0.0, 0.0]
 [-30.373387605351038, 0.0, 0.0]
 [-22.58088636068332, 0.0, 0.0]
 [-15.415073949531767, 0.0, 0.0]
 [-9.247826940998431, 0.0, 0.0]
 [-3.1536633713626006, 0.0, 0.0]
 [3.316607892944261, 0.0, 0.0]
 [11.270396552232064, 0.0, 0.0]
 [31.305774186792927, 0.0, 0.0]
 [-70.0, 0.0, 0.002]
 [-41.67731082504514, 0.0015637472521185037, 0.0018367757666629932]
 [-30.03709574900961, 0.0026570132968968783, 0.0017125787059129147]
 [-18.33994018434038, 0.004186562526044538, 0.001517913783719937]
 [-11.413937971084886, 0.005260979234787077, 0.0013573964698949486]
 [-4.015158228163987, 0.006335079005019768, 0.001156419906274448]
 [2.7415098558422852, 0.0069954312400350846, 0.0009783897496250652]
 [11.482002365218705, 0.007324072175246107, 0.0008070954488123511]
 [34.25257307711372, 0.00726470303241468, 0.0006219873670921703]
 [-70.0, 0.00726470303241468, 0.002]
 [-41.67209249778088, 0.008235824494572993, 0.0018367282696245169]
 [-29.632211176624487, 0.008903490530498086, 0.001707206454564266]
 [-18.07415825997539, 0.00971993832741183, 0.0015124063305201837]
 [-11.035846267433644, 0.010215403490835455, 0.0013476718895716244]
 [-3.6552919447937664, 0.010544058161272057, 0.0011464267297985767]
 [3.2277410007693437, 0.010539552127888228, 0.0009668235121088781]
 [12.137732867490946, 0.01022873609482903, 0.0007973432175077396]
 [37.5535543554092, 0.009458879055061242, 0.0006099530067967963]
 [-70.0, 0.009458879055061242, 0.002]
 [-41.68333530412398, 0.010250424914749865, 0.0018368305826776021]
 [-29.348447851867654, 0.010790450606399993, 0.0017033973124454677]
 [-17.893798384427868, 0.011388448853411661, 0.0015086445833566026]
 [-10.772219397472174, 0.011702775151996631, 0.001340845723479263]
 [-3.404966777117772, 0.011799537750281223, 0.0011394931468134077]
 [3.5712380280576346, 0.01158385527054404, 0.0009587903667617195]
 [12.671607639541099, 0.011073106505474545, 0.0007896966586126385]
 [40.56894921471625, 0.010064811228194283, 0.0006004897010490106]
 [-70.0, 0.010064811228194283, 0.002]
 [-41.68515742654379, 0.010806854054240072, 0.001836847158032256]
 [-29.11625863609992, 0.011317091055938177, 0.0017002453649159488]
 [-17.743873513509087, 0.011852249364011734, 0.0015054953722612855]
 [-10.556671286579812, 0.012114329441602796, 0.0013352311670928776]
 [-3.1987188416207264, 0.012140867996239412, 0.0011337876564017416]
 [3.8549995573585694, 0.011858485407815702, 0.0009522376153396214]
 [13.270504388251215, 0.011276113867131902, 0.0007814171580837872]
 [44.44451590953645, 0.010172086995604356, 0.0005900509221815409]
 [-70.0, 0.010172086995604356, 0.002]
 [-44.25141475399345, 0.010815270867896994, 0.0018587060039521666]
 [-44.25141475399345, 0.010815270867896994, 0.0018587060039521666]
 [-26.71894510387165, 0.01134881767788771, 0.001718038495699933]
 [-13.212840431383114, 0.011810991377125008, 0.0015596844243415636]
 [-1.4213071594039335, 0.012119393604063397, 0.0013958847826332952]
 [11.822149160782486, 0.012235318651998452, 0.0012289867534634987]
 [35.38772430553971, 0.012113112093169252, 0.0010546553540306226]
 [-70.0, 0.012113112093169252, 0.002]
 [-38.743652947840566, 0.012675171519238025, 0.001841000277404291]
 [-26.326838630961777, 0.012980409012255487, 0.001732550954407915]
 [-11.683035058514747, 0.013330399824453826, 0.0015557268669553332]
 [-1.4529344930916581, 0.013467891479019516, 0.001411354069741393]
 [11.972659698692194, 0.013438255359552197, 0.0012405774931141171]
 [34.039360803348174, 0.013179092224365151, 0.0010725439791417167]
 [-70.0, 0.013179092224365151, 0.002]
 [-38.82210544166575, 0.01365483220391124, 0.001841609542203679]
 [-26.74905449193163, 0.013895238239440407, 0.00173687980785475]
 [-12.088629494982374, 0.014154485971656822, 0.0015612937377248416]
 [-2.0381146851502594, 0.014220512152280294, 0.0014196375094006565]
 [11.163953774499749, 0.01411130630973457, 0.0012494800027660696]
 [31.68198181728438, 0.01378459738277541, 0.0010847915401086476]
 [-70.0, 0.01378459738277541, 0.002]
 [-38.8855789961404, 0.014211262235801134, 0.0018421007967298554]
 [-27.243986379873636, 0.014412518103686128, 0.001741884104921482]
 [-12.558517102487832, 0.014622996955221939, 0.0015676980704734055]
 [-2.7235849289998586, 0.014653089471549838, 0.001429366980406193]
 [10.230304202274768, 0.014505957501061097, 0.0012600095142275645]
 [29.11662765063259, 0.014155926479442476, 0.001099370450497035]
 [-70.0, 0.014155926479442476, 0.002]
 [-38.84908477798218, 0.014553867484661885, 0.001841818531611459]
 [-27.904336046936333, 0.014725738523123864, 0.001748417719873666]
 [-13.16111335648621, 0.014909903971028343, 0.001575813287859014]
 [-3.649905636578793, 0.014923619365940777, 0.001442522936823092]
 [8.992422562482476, 0.014763450588664215, 0.0012743584237933767]
 [25.912233241392062, 0.014420141915670369, 0.0011196024871240316]
 [-70.0, 0.014420141915670369, 0.002]
 [-38.489068929462995, 0.014802692293858265, 0.0018390068005848192]
 [-28.911663753691048, 0.01494253917237692, 0.0017580432383072961]
 [-14.047981094762786, 0.015112894768636411, 0.0015875149704900982]
 [-5.135478416712126, 0.015122713014711362, 0.0014635731123603343]
 [7.0484018683326966, 0.014969809662555053, 0.0012977332542507042]
 [21.245398345101123, 0.014665363227680294, 0.0011536109069985277]
 [70.07506229454506, 0.014003447292867385, 0.0009679126028863773]
 [-70.0, 0.014003447292867385, 0.002]
 [-37.97192970876727, 0.01442841588814435, 0.0018348743642323851]
 [-23.25948664313166, 0.014666339381583484, 0.0016995718231762658]
 [-8.690118819901281, 0.014815508105905983, 0.0015137975718337734]
 [-7.034373315703127, 0.01481867585412342, 0.0014903790351006219]</code></pre> <p>Besides the generic <code>plot</code> function, Neuroblox includes some plotting recipes specifically for neuron models. A raster plot with chosen spike threshold</p> <pre><code class="julia hljs">fig = rasterplot(qif, sol; threshold=-<span class=hljs-number >40</span>);
fig</code></pre> <img src="/course/assets/pages/neuron_mass/code/output/qif_raster.svg" alt=""> <p>and a firing rate plot, again by setting the spike threshold and the window size for averaging</p> <pre><code class="julia hljs">fig = frplot(qif, sol; threshold=-<span class=hljs-number >40</span>, win_size=<span class=hljs-number >20</span>);
fig</code></pre> <img src="/course/assets/pages/neuron_mass/code/output/qif_fr.svg" alt=""> <p>We can easily extract the voltage timeseries of neurons by</p> <pre><code class="julia hljs">V = voltage_timeseries(qif, sol) <span class=hljs-comment >## equivalent to `state_timeseries(qif, sol, &quot;V&quot;)`</span>
fig = lines(V);
fig</code></pre> <img src="/course/assets/pages/neuron_mass/code/output/qif_timeseries.svg" alt=""> <p>Finally we simulate an HH neuron with stochastic dynamics which was introduced in <a href="https://doi.org/10.1073/pnas.2120808119">this article on deep brain stimulation int he subthalamic nucleus</a>. The model includes a brownian noise term affecting <code>D&#40;V&#41;</code> which you can inspect using the <code>equations</code> function.</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> StochasticDiffEq <span class=hljs-comment >## to access stochastic DE solvers</span>

<span class=hljs-meta >@named</span> hh = HHNeuronExci_STN_Adam_Blox(; σ=<span class=hljs-number >2</span>) <span class=hljs-comment >## σ is the brownian noise amplitude</span>

sys = system(hh)
prob = SDEProblem(sys, [], (<span class=hljs-number >0</span>, <span class=hljs-number >1000</span>))
sol = solve(prob, RKMil())

<span class=hljs-comment ># Plot the powerspectrum of the solution</span>
fig = powerspectrumplot(hh, sol; samplig_rate=<span class=hljs-number >0.01</span>);
fig</code></pre> <img src="/course/assets/pages/neuron_mass/code/output/hh_power.svg" alt=""> <p>We can use all other plots from above with this stochastic HH neuron since it is a subtype of <code>Neuron</code>. Given its stochastic nature it might be additionally meaningful to show the powerspectrum of its activity.</p> <blockquote> <p><strong><em>Exercise:</em></strong> Try changing the influence of the stochastic term. What do you notice about the powerspectrum of <code>HHNeuronExci_STN_Adam_Blox</code>?</p> </blockquote> <h2 id=sources ><a href="#sources" class=header-anchor >Sources</a></h2> <p>External sources in Neuroblox as a particular Blox subtype &#40;<code>&lt;: AbstractBlox</code>&#41; which contains a system with output and no input variables. Naturally source Bloxs can only connect <strong>to</strong> other &#40;non-source&#41; Blox and can not receive connections from any Blox. There are two main categories of sources, ones with continuous dynamics for their variables and ones that operate through events &#40;callbacks&#41;.</p> <h3 id=continuous_input_sources ><a href="#continuous_input_sources" class=header-anchor >Continuous input sources</a></h3> <p>These sources are comprised of algebraic &#40;and potentially differential&#41; equations that become part of the dynamics of Bloxs that the source connects to. We will drive the <code>WilsonCowan</code> Blox above with a <code>ConstantInput</code> source. The connection between the two Bloxs looks like</p> <pre><code class="julia hljs"><span class=hljs-meta >@named</span> inp = ConstantInput(; I=<span class=hljs-number >3</span>)

connection_rule(inp, nm)</code></pre><pre><code class="plaintext hljs">Connections :
	 inp =&gt; nm
Equations :
	 nm₊jcn(t) ~ w_inp_nm*inp₊u(t)
Weights :
	 w_inp_nm
</code></pre> <p>This source simply adds a fixed current to the input variable &#40;<code>nm₊jcn</code>&#41; of the downstream &#40;destination&#41; Blox.</p> <pre><code class="julia hljs">g = MetaDiGraph()
add_edge!(g, inp =&gt; nm, weight = <span class=hljs-number >1</span>)

<span class=hljs-meta >@named</span> sys = system_from_graph(g)
prob = ODEProblem(sys, [], tspan)
sol = solve(prob, Tsit5())

fig, ax = plot(sol);
axislegend(ax)
fig</code></pre> <img src="/course/assets/pages/neuron_mass/code/output/wc_input.svg" alt=""> <p>Notice how the E-I balance has shiften after adding our input. We will work with a more complex circuit for E-I balance on the next session and learn more about its intricacies.</p> <p>We can create custom sources with continuous input the same way we create custom Bloxs and write custom connection rules for them as we have seen in the previous session.</p> <h3 id=event-based_spike_sources ><a href="#event-based_spike_sources" class=header-anchor >Event-based spike sources</a></h3> <p>This type of source operates entirely through callbacks. One common example is a source that simulates spiking from presynaptic neurons that we do not explicitly include in our model. Each time the source&#39;s callback is triggered, it affects parameters and/or variables of its postsynaptic neurons which are part of our model. Commonly it is assumed that the spiking of neurons follows a Poisson process. Therefore we have implemented a source in Neuroblox that generates spikes that are distributed according to a Poisson distribution for any finite length of time.</p> <pre><code class="julia hljs">tspan = (<span class=hljs-number >0</span>, <span class=hljs-number >200</span>) <span class=hljs-comment ># ms</span>
spike_rate = <span class=hljs-number >0.01</span> <span class=hljs-comment ># spikes / ms</span>

<span class=hljs-meta >@named</span> spike_train_rate = PoissonSpikeTrain(spike_rate, tspan)</code></pre><pre><code class="plaintext hljs">Neuroblox.PoissonSpikeTrain{Vector{Float64}}(:spike_train_rate, nothing, 1, [0.01], [(0, 200)], 0.01, Random.MersenneTwister(1234))</code></pre>
<p>The <code>PoissonSpikeTrain</code> needs a timespan <code>Tuple</code> &#40;<code>tspan</code>&#41; to generate spikes within it. Above we have set a fixed <code>spike_rate</code> for our process. Alternatively we can also define the spike train with a variable <code>spike_rate</code> that is sampled according to any univariate distribution.</p>
<pre><code class="julia hljs"><span class=hljs-keyword >using</span> Distributions

tspan = (<span class=hljs-number >0</span>, <span class=hljs-number >200</span>) <span class=hljs-comment ># ms</span>
<span class=hljs-comment ># Define a `NamedTuple` holding a `distribution` and a `dt` field</span>
spike_rate = (distibution = Normal(<span class=hljs-number >1</span>, <span class=hljs-number >0.1</span>), dt = <span class=hljs-number >10</span>)

<span class=hljs-meta >@named</span> spike_train_dist = PoissonSpikeTrain(spike_rate, tspan)</code></pre><pre><code class="plaintext hljs">Neuroblox.PoissonSpikeTrain{@NamedTuple{distibution::Distributions.Normal{Float64}, dt::Int64}}(:spike_train_dist, nothing, 1, (distibution = Distributions.Normal{Float64}(μ=1.0, σ=0.1), dt = 10), (0, 200), 0.01, Random.MersenneTwister(1234))</code></pre>
<p>When choosing a variable <code>spike_rate</code> we need to set a <code>dt</code> that dictates how often the <code>distribution</code> will generate a new <code>spike_rate</code> sample. The units of <code>dt</code> match the units of <code>tspan</code> which by default is ms in Neuroblox.</p>
<blockquote>
<p><strong><em>Exercise:</em></strong> Define a <code>LIFExciNeuron</code>, connect a <code>PoissonSpikeTrain</code> to it and tune the source parameters to make the neuron spike. You can visualize spiking using <code>rasterplot</code> and <code>frplot</code> as above.</p>
</blockquote>
<p>We can create custom event-based spike sources with a bit more effort compared to continuous ones. Here is a worked example with comments on the necessary steps :</p>
<pre><code class="julia hljs"><span class=hljs-keyword >struct</span> BernoulliSpikes &lt;: SpikeSource
    name <span class=hljs-comment >## necessary field</span>
    namespace <span class=hljs-comment >## necessary field</span>
    tspan <span class=hljs-comment >## necessary field</span>
    probability_spike
    dt
    <span class=hljs-keyword >function</span> BernoulliSpikes(probability_spike, tspan, dt; name, namespace=<span class=hljs-literal >nothing</span>)
        new(name, namespace, tspan, probability_spike, dt)
    <span class=hljs-keyword >end</span>
<span class=hljs-keyword >end</span>

<span class=hljs-keyword >import</span> Neuroblox: generate_spike_times, connection_spike_affects

<span class=hljs-keyword >function</span> generate_spike_times(source::BernoulliSpikes)
    <span class=hljs-comment ># Write a function that generates and returns a vector of spike times.</span>

    t_range = source.tspan[<span class=hljs-number >1</span>]:source.dt:source.tspan[<span class=hljs-number >2</span>]
    t_spikes = <span class=hljs-built_in >Float64</span>[]
    <span class=hljs-keyword >for</span> t <span class=hljs-keyword >in</span> t_range
        <span class=hljs-keyword >if</span> rand(Bernoulli(source.probability_spike))
            push!(t_spikes, t)
        <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >return</span> t_spikes
<span class=hljs-keyword >end</span>

<span class=hljs-keyword >function</span> connection_spike_affects(source::BernoulliSpikes, ifn::IFNeuron, w)
    <span class=hljs-comment ># Write all equations that should be evaluated each time `source` spikes.</span>
    <span class=hljs-comment ># `w` is the symbolic connection weight, same as in `connection_equations`.</span>

    eqs = [ifn.I_in ~ ifn.I_in + w]
    <span class=hljs-keyword >return</span> eqs
<span class=hljs-keyword >end</span>

tspan = (<span class=hljs-number >0</span>, <span class=hljs-number >500</span>)
<span class=hljs-meta >@named</span> s = BernoulliSpikes(<span class=hljs-number >0.05</span>, tspan, <span class=hljs-number >5</span>)
<span class=hljs-meta >@named</span> ifn = IFNeuron()

g = MetaDiGraph()
add_edge!(g, s =&gt; ifn, weight=<span class=hljs-number >1</span>)
<span class=hljs-meta >@named</span> sys = system_from_graph(g)

prob = ODEProblem(sys, [], tspan)
sol = solve(prob, Tsit5())

fig = rasterplot(ifn, sol);
fig</code></pre>
<img src="/course/assets/pages/neuron_mass/code/output/ifn_input.svg" alt="">
<p>Notice how spikes become more and more frequently over time. Can you tell why this is happening?</p>
<h3 id=deep_brain_stimulation ><a href="#deep_brain_stimulation" class=header-anchor >Deep Brain Stimulation</a></h3>
<p>Neuroblox contains specialized sources that are common to the field of Deep Brain Stimulation &#40;DBS&#41;. These sources simulate stimulation patterns by external probes that are continuous in time, yet contain discrete changes &#40;jumps&#41; on their variables. Even though these sources are often used in DBS protocols, they are implemented as any other source so they can be connected to any other Bloxs given a connection rule. We will first visualize the sources on their own and then connect them to an HH excitatory neuron.</p>
<pre><code class="julia hljs"><span class=hljs-comment ># Set the random seed for reproducible results</span>
<span class=hljs-keyword >using</span> Random
Random.seed!(<span class=hljs-number >1</span>)

<span class=hljs-comment ># Square pulse stimulus</span>
<span class=hljs-meta >@named</span> stim = DBS(
                frequency=<span class=hljs-number >100.0</span>, <span class=hljs-comment >## Hz</span>
                amplitude=<span class=hljs-number >200.0</span>, <span class=hljs-comment >## arbitrary units, depends on how the stimulus is used in the model</span>
                pulse_width=<span class=hljs-number >0.5</span>, <span class=hljs-comment >## ms</span>
                offset=<span class=hljs-number >0.0</span>,
                start_time=<span class=hljs-number >5.0</span>, <span class=hljs-comment >## ms</span>
                smooth=<span class=hljs-number >0.0</span> <span class=hljs-comment >## modulates smoothing effect</span>
);

tspan = (<span class=hljs-number >0</span>, <span class=hljs-number >100</span>) <span class=hljs-comment >## ms</span>
dt = <span class=hljs-number >0.001</span> <span class=hljs-comment >## ms</span>

time = tspan[<span class=hljs-number >1</span>]:dt:tspan[<span class=hljs-number >2</span>]
<span class=hljs-comment ># `stimulus` is a function that is also a field of `DBS` objects.</span>
<span class=hljs-comment ># It turns a time vector into a vector of stimulus values of the same length given the object&#x27;s parameters.</span>
stimulus = stim.stimulus.(time)

fig = Figure();
ax1 = Axis(fig[<span class=hljs-number >1</span>,<span class=hljs-number >1</span>]; xlabel = <span class=hljs-string >&quot;time (ms)&quot;</span>, ylabel = <span class=hljs-string >&quot;stimulus&quot;</span>)
lines!(ax1, time, stimulus)
fig</code></pre>
<img src="/course/assets/pages/neuron_mass/code/output/stim.svg" alt="">
<p>We can also generate a smoothed pulse train as</p>
<pre><code class="julia hljs"><span class=hljs-meta >@named</span> stim_smooth = DBS(
                frequency=<span class=hljs-number >100.0</span>,
                amplitude=<span class=hljs-number >200.0</span>,
                pulse_width=<span class=hljs-number >0.5</span>,
                offset=<span class=hljs-number >0.0</span>,
                start_time=<span class=hljs-number >5.0</span>,
                smooth=<span class=hljs-number >1e-3</span>
);

smooth_stimulus = stim_smooth.stimulus.(time)

fig = Figure();
ax1 = Axis(fig[<span class=hljs-number >1</span>,<span class=hljs-number >1</span>]; xlabel = <span class=hljs-string >&quot;time (ms)&quot;</span>, ylabel = <span class=hljs-string >&quot;stimulus&quot;</span>)
lines!(ax1, time, stimulus) <span class=hljs-comment >## plot the un-smoothed stimulus from above</span>
xlims!(ax1, <span class=hljs-number >4.9</span>, <span class=hljs-number >5.6</span>) <span class=hljs-comment >## set the x-axis limits for better visibility of a smoothed pulse</span>

ax2 = Axis(fig[<span class=hljs-number >2</span>,<span class=hljs-number >1</span>]; xlabel = <span class=hljs-string >&quot;time (ms)&quot;</span>, ylabel = <span class=hljs-string >&quot;stimulus&quot;</span>)
lines!(ax2, time, smooth_stimulus) <span class=hljs-comment >## plot the smoothed stimulus</span>
xlims!(ax2, <span class=hljs-number >4.9</span>, <span class=hljs-number >5.6</span>) <span class=hljs-comment >## set the x-axis limits for better visibility of a smoothed pulse</span>

fig</code></pre>
<img src="/course/assets/pages/neuron_mass/code/output/stim_comparison.svg" alt="">
<p>It is also possible to create a stimulus protocol that does not follow a simple periodic stimulation schedule as above and contains multiple pulses before a quiet time window:</p>
<pre><code class="julia hljs">frequency = <span class=hljs-number >20.0</span>
amplitude = <span class=hljs-number >1.0</span>
pulse_width = <span class=hljs-number >20.0</span>
smooth = <span class=hljs-number >3e-4</span>
pulse_start_time = <span class=hljs-number >0.01</span>
offset = <span class=hljs-number >0</span>
pulses_per_burst = <span class=hljs-number >3</span>
bursts_per_block = <span class=hljs-number >2</span>
pre_block_time = <span class=hljs-number >200.0</span>
inter_burst_time = <span class=hljs-number >200.0</span>

<span class=hljs-meta >@named</span> dbs = ProtocolDBS(
                frequency=frequency,
                amplitude=amplitude,
                pulse_width=pulse_width,
                smooth=smooth,
                offset=offset,
                pulses_per_burst=pulses_per_burst,
                bursts_per_block=bursts_per_block,
                pre_block_time=pre_block_time,
                inter_burst_time=inter_burst_time,
                start_time = pulse_start_time);

t_end = get_protocol_duration(dbs)
t_end = t_end + inter_burst_time
tspan = (<span class=hljs-number >0.0</span>, t_end)
dt = <span class=hljs-number >0.001</span>

time = tspan[<span class=hljs-number >1</span>]:dt:tspan[<span class=hljs-number >2</span>]
stimulus = dbs.stimulus.(time)

fig = Figure();
ax1 = Axis(fig[<span class=hljs-number >1</span>,<span class=hljs-number >1</span>]; xlabel = <span class=hljs-string >&quot;time (ms)&quot;</span>, ylabel = <span class=hljs-string >&quot;stimulus&quot;</span>)
lines!(ax1, time, stimulus)
fig</code></pre>
<img src="/course/assets/pages/neuron_mass/code/output/stim_protocol.svg" alt="">
<p>Now let&#39;s finally connect our <code>ProtocolDBS</code> source to an HH excitatory neuron and simulate</p>
<pre><code class="julia hljs"><span class=hljs-meta >@named</span> nn = HHNeuronExciBlox(I_bg=<span class=hljs-number >0.4</span>)

g = MetaDiGraph()
add_edge!(g, dbs =&gt; nn, weight = <span class=hljs-number >10.0</span>)

<span class=hljs-meta >@named</span> sys = system_from_graph(g)
prob = ODEProblem(sys, [], tspan)

transitions_inds = detect_transitions(time, stimulus; atol=<span class=hljs-number >0.001</span>)
transition_times = time[transitions_inds]
transition_values = stimulus[transitions_inds]
sol = solve(prob, Vern7(), saveat=dt, tstops = transition_times);</code></pre>
<blockquote>
<p><strong><em>NOTE</em>:</strong> We have used <code>detect_transitions</code> to find all points where the stimulation switches on and off. Such points can lead to discontinuities in the dynamics of our model and thus to imprecise solutions. Adding the transition points explicitly as <code>tstops</code> when solving will force the chosen solver to stop righ before and after each transition and evaluate the equations for greater precision and stability.</p>
</blockquote>
<pre><code class="julia hljs"><span class=hljs-comment ># Retrive the timeseries of the voltage variable (`nn₊V`) from the solution</span>
v = voltage_timeseries(nn, sol)

<span class=hljs-comment ># Plot the voltage and stimulation timeseries on two axes on the same window.</span>
fig = Figure();
ax1 = Axis(fig[<span class=hljs-number >1</span>,<span class=hljs-number >1</span>]; xlabel = <span class=hljs-string >&quot;time (ms)&quot;</span>, ylabel = <span class=hljs-string >&quot;Voltage (mV)&quot;</span>)
lines!(ax1, sol.t, v)

ax2 = Axis(fig[<span class=hljs-number >2</span>,<span class=hljs-number >1</span>]; xlabel = <span class=hljs-string >&quot;time (ms)&quot;</span>, ylabel = <span class=hljs-string >&quot;Stimulus (μA/cm²)&quot;</span>)
lines!(ax2, sol.t, stimulus)
fig</code></pre>
<img src="/course/assets/pages/neuron_mass/code/output/stim_hh.svg" alt="">
<h2 id=challenge_problems ><a href="#challenge_problems" class=header-anchor >Challenge Problems</a></h2>
<ul>
<li><p>Implement a custom <code>SpikeSource</code> of your choice. Hint: the <code>BernoulliSpikes</code> implementation above.</p>

<li><p>Write a function that plots the <a href="https://en.wikipedia.org/wiki/F-I_curve">f-I curve</a> of a Blox. Hint: Consider a <code>ContantInput</code> source to vary input currents and <code>firing_rate&#40;blox, solution; threshold&#61;...&#41;</code> to calculate firing rates.</p>

<li><p>Write a function that plots the <a href="https://en.wikipedia.org/wiki/Peristimulus_time_histogram">Peristimulus time histogram</a> of a Blox around a given timepoint. Hint: use the <code>hist</code> or <code>barplot</code> plotting functions from <code>Makie</code> and <code>detect_spikes&#40;blox, solution; threshold&#61;...&#41;</code> to find spikes.</p>

</ul>
<h2 id=references ><a href="#references" class=header-anchor >References</a></h2>
<ul>
<li><p>&#91;1&#93; Gerstner W, Kistler WM, Naud R, Paninski L. Neuronal Dynamics: From Single Neurons to Networks and Models of Cognition, Parts I &amp; II. Cambridge University Press; 2014.</p>

<li><p>&#91;2&#93; Adam, Elie M., et al. &quot;Deep brain stimulation in the subthalamic nucleus for Parkinson&#39;s disease can restore dynamics of striatal networks.&quot; Proceedings of the National Academy of Sciences 119.19 &#40;2022&#41;: e2120808119.</p>

</ul>

<div class=page-foot >
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> Neuroblox Inc. Last modified: January 06, 2025.
    Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
</div>
</div>
  </main> 
  <script src="/course/libs/vela/metisMenu.min.js"></script>
  <script src="/course/libs/vela/slideout.min.js"></script>
  
  
    <script src="/course/libs/highlight/highlight.min.js"></script>
<script>hljs.highlightAll();hljs.configure({tabReplace: '    '});</script>