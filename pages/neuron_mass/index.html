<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/course/libs/highlight/styles/github.min.css"> <link href="/course/css/franklin.css" rel=stylesheet > <link href="/course/css/vela.css" rel=stylesheet > <script src="/course/libs/vela/jquery.min.js"></script> <link rel=icon  href="/course/assets/favicon.png"> <title>Franklin Example | Vela</title> <div class="main-nav slideout-menu slideout-menu-left" id=menu > <div class=flex-container > <span class=sidebar-brand > <h3 style='font-size: 25px'>Vela Template</h3> </span> </div> <nav class=sidebar-nav > <ul class=metismenu  id=metismenu  > <li><a href="/course/index.html">Home</a> <li><a href="/course/pages/install">Installing Julia</a> <li><a href="/course/pages/intro_julia">Introduction to Julia</a> <li><a href="/course/pages/intro_diffeq">Differential Equations with ModelingToolkit</a> <li><a href="/course/pages/intro_plot">Plotting with Makie</a> <li><a href="/course/pages/custom">Custom Bloxs and Connections</a> <li><a href="/course/pages/neuron_mass">Neurons, Neural Masses and Sources</a> <li><a href="" class=has-arrow >Circuit Modelis</a> <ul> <li><a href="/course/pages/circuits">Introduction</a> <li><a href="/course/pages/CS_circuit">Biomimetic Corticostriatal assemblies</a> <li><a href="/course/pages/PING_circuit">Pyramidal-Interneuron Gamma network</a> </ul> <li><a href="/course/pages/decision_making">Decision Making</a> <li><a href="/course/pages/learning">Synaptic Plasticity and Reinforcement Learning</a> <li><a href="/course/pages/DCM">Spectral Dynamic Causal Modeling</a> </ul> </nav> </div> <main id=panel  class="slidout-panel slideout-panel-left"> <div class="toggle-button hamburger hamburger--spin"> <div class=hamburger-box > <div class=hamburger-inner ></div> </div> </div> <h1 class="page title">Neurons, Neural Masses and Sources</h1> <hr> <div class=franklin-content ><div class=franklin-toc ><ol><li><a href="#introduction">Introduction</a><li><a href="#neurons_and_neural_masses">Neurons and neural masses</a><li><a href="#sources">Sources</a><ol><li><a href="#continuous_input_sources">Continuous input sources</a><li><a href="#event-based_spike_sources">Event-based spike sources</a><li><a href="#deep_brain_stimulation">Deep Brain Stimulation</a></ol><li><a href="#challenge_problems">Challenge Problems</a><li><a href="#references">References</a></ol></div> <h1 id=neurons_neural_masses_and_sources ><a href="#neurons_neural_masses_and_sources" class=header-anchor >Neurons, Neural Masses and Sources</a></h1> <h2 id=introduction ><a href="#introduction" class=header-anchor >Introduction</a></h2> <p>The main distinction between the neuron, neural mass and source Blox we will encounter on this session is the mechanism by which they communicate with other Bloxs. All neural mass Bloxs, some sources, and neurons of the Hodgkin-Huxley &#40;HH&#41; family have continuous output variables which are included as terms in the postsynaptic Blox&#39;s differential equations. The alternative is an event-based connection. Neurons of the Izhikevich and the Integrate-and-fire families of models operate this way as we have previosuly seen. Sources that simulate spike trains may also operate the same way via callbacks.</p> <p>Learning goals :</p> <ul> <li><p>visualize results from neuron and neural mass Blox simulations</p> <li><p>introduce external sources as Blox</p> <li><p>drive single neuron and neural mass activity using external sources</p> </ul> <h2 id=neurons_and_neural_masses ><a href="#neurons_and_neural_masses" class=header-anchor >Neurons and neural masses</a></h2> <p>As a first example we will consider a neural mass <code>WilsonCowan</code> Blox of Exhitatation-Inhibition &#40;E-I&#41; balance. This is a two-dimensional reduction over a population of excitatory and inhibitory neurons with continuous dynamics.</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Neuroblox
<span class=hljs-keyword >using</span> OrdinaryDiffEq
<span class=hljs-keyword >using</span> CairoMakie

<span class=hljs-meta >@named</span> nm = WilsonCowan()
<span class=hljs-comment ># Retrieve the simplified ODESystem of the Blox</span>
sys = system(nm)
tspan = (<span class=hljs-number >0</span>, <span class=hljs-number >100</span>) <span class=hljs-comment ># ms</span>
prob = ODEProblem(sys, [], tspan)
sol = solve(prob, Tsit5())

fig, ax = plot(sol);
axislegend(ax) <span class=hljs-comment >## add legend to the plot</span>
fig</code></pre> <img src="/course/assets/pages/neuron_mass/code/output/wc_all.svg" alt=""> <p>Using the generic <code>plot</code> function we visualize all states of our model. We can retrieve specific variables by using</p> <pre><code class="julia hljs">E = state_timeseries(nm, sol, <span class=hljs-string >&quot;E&quot;</span>) <span class=hljs-comment >## retrieves state `E` of Blox `nm`</span>
fig = lines(E); <span class=hljs-comment >## simple line plot</span>
fig</code></pre> <img src="/course/assets/pages/neuron_mass/code/output/wc_timeseries.svg" alt=""> <p>Moving on to neurons, we will use a Quadratic Integrate-and-fire &#40;QIF&#41; neuron model with an added callback that increases the input current after 60 ms.</p> <pre><code class="julia hljs"><span class=hljs-meta >@named</span> qif = QIFNeuron(; I_in=<span class=hljs-number >4</span>)
<span class=hljs-comment ># We can pass additional events to be included in the final system.</span>
sys = system(qif; discrete_events = [<span class=hljs-number >60</span>] =&gt; [qif.I_in ~ <span class=hljs-number >10</span>])
tspan = (<span class=hljs-number >0</span>, <span class=hljs-number >100</span>) <span class=hljs-comment ># ms</span>
prob = ODEProblem(sys, [], tspan)
sol = solve(prob, Tsit5())</code></pre><pre><code class="plaintext hljs">retcode: Success
Interpolation: specialized 4th order &quot;free&quot; interpolation
t: 105-element Vector{Float64}:
   0.0
   0.11043012839242242
   0.4831122698374086
   0.9075602575526773
   1.5200686806970882
   2.2328471482119903
   3.179283803135524
   4.296999521538077
   5.680584095552938
   7.284240487553793
   9.02838833611385
  10.944376006305728
  10.944376006305728
  11.806243477467977
  12.507083919268519
  13.725829131120802
  14.846483210612723
  16.459754941398735
  18.13719923884131
  20.06298873869951
  21.89673316308031
  21.89673316308031
  22.769265183514467
  23.509620156433616
  24.74656158822878
  25.91439739702001
  27.55706115899247
  29.279816065898917
  31.239265813602053
  32.847486522824546
  32.847486522824546
  33.73832485228818
  34.522779204345994
  35.78701120083786
  37.00863072494362
  38.68992801245977
  40.46445532607644
  42.54728239269265
  43.79232334775998
  43.79232334775998
  44.6623361403194
  45.45053083019197
  46.69126236679823
  47.91281314227624
  49.574725268613115
  51.34355591430804
  53.390786634643376
  54.737134981178244
  54.737134981178244
  55.61412231656487
  56.4059804028564
  57.65528256735466
  58.88241014561676
  60.0
  60.0
  61.58345720621785
  62.604401473389395
  62.604401473389395
  63.433665102579354
  63.96423511336798
  65.01256918470257
  65.9081694245169
  67.15661886899163
  68.35112038877038
  68.35112038877038
  69.17863924344388
  69.63416314808357
  70.64730452468132
  71.46328875213001
  72.66326979658155
  73.8373532949164
  74.09169019497809
  74.09169019497809
  74.91412191038457
  75.67156176911821
  76.78766667736804
  77.90888720668318
  79.26156973085253
  79.8335282211436
  79.8335282211436
  80.65647041845048
  81.36318972117941
  82.4659185989028
  83.53777638628068
  84.87049616667167
  85.57819074723436
  85.57819074723436
  86.40760976231572
  87.07512051999869
  88.17248296902983
  89.20724094130188
  90.5263822202019
  91.3243156278441
  91.3243156278441
  92.16944080758037
  92.81124229099764
  93.9152415983141
  94.92824729541945
  96.24378974375422
  97.07163647332142
  97.07163647332142
  97.93113668595615
  98.56352477583438
  99.67769957406252
 100.0
u: 105-element Vector{Vector{Float64}}:
 [-70.0, 0.0, 0.0]
 [-64.56634709526935, 0.0, 0.0]
 [-50.82142562689537, 0.0, 0.0]
 [-40.38681631810811, 0.0, 0.0]
 [-30.373387605351038, 0.0, 0.0]
 [-22.58088636068332, 0.0, 0.0]
 [-15.415073949531767, 0.0, 0.0]
 [-9.247826940998431, 0.0, 0.0]
 [-3.1536633713626006, 0.0, 0.0]
 [3.316607892944261, 0.0, 0.0]
 [11.270396552232064, 0.0, 0.0]
 [24.999999999999904, 0.0, 0.0]
 [-70.0, 0.0, 0.002]
 [-41.4666037353961, 0.0015813938878038792, 0.001834845778335228]
 [-29.899143183463426, 0.002673254237977362, 0.0017106550875668031]
 [-18.1733570665898, 0.004212159071009723, 0.0015143735700861446]
 [-11.278119355856822, 0.005282783672590073, 0.0013538284402036997]
 [-3.86323075863839, 0.006354413595203029, 0.0011521264121531953]
 [2.9138749074197823, 0.007007272796589872, 0.000974203428109749]
 [11.713843537501727, 0.007327273858917162, 0.0008035514337507621]
 [24.99999999999993, 0.0073262701358627405, 0.0006689214678518182]
 [-70.0, 0.0073262701358627405, 0.002]
 [-41.25592061151829, 0.008313379032416114, 0.0018328900410564937]
 [-29.268299349197637, 0.008980278516893566, 0.0017020926783171823]
 [-17.685139368887857, 0.009795850812693978, 0.0015040543146776165]
 [-10.680272867783026, 0.010279014307629102, 0.0013382740450571856]
 [-3.267878764588343, 0.010587229392428647, 0.0011355468978557902]
 [3.6928630609265394, 0.010558455114872406, 0.0009558434781754079]
 [12.946021612857953, 0.010219310477063674, 0.0007857582732337976]
 [24.999999999999993, 0.009777120031341235, 0.0006690286369819826]
 [-70.0, 0.009777120031341235, 0.002]
 [-40.901654922488554, 0.010573627528910426, 0.001829537765239203]
 [-28.514717244873275, 0.011102781293943594, 0.0016915037267459978]
 [-17.065254378373105, 0.01166872958687907, 0.001490623834372233]
 [-9.96052351852037, 0.011938456528324768, 0.0013192095889042637]
 [-2.5296842066916403, 0.011965648352139776, 0.0011150542230220304]
 [4.663626148855074, 0.011677000391276357, 0.0009337470571195236]
 [15.067328906718165, 0.011060621770137516, 0.0007581815633966216]
 [24.999999999999975, 0.010599274537991752, 0.0006694245954469094]
 [-70.0, 0.010599274537991752, 0.002]
 [-41.30540762148384, 0.011311139326135344, 0.0018333518459909479]
 [-28.704724174169197, 0.011789345456832214, 0.001694396164722437]
 [-17.336977827598897, 0.012270693685618454, 0.0014966859227436343]
 [-10.156576443775377, 0.012477746465089269, 0.0013245836738952565]
 [-2.7678024890278987, 0.012431488925540196, 0.0011217690980205174]
 [4.3936576305927, 0.012078601338891387, 0.0009399053777061221]
 [14.450770022459151, 0.011410506263685635, 0.0007659034700905141]
 [24.99999999999996, 0.01087447121069232, 0.0006694262619498698]
 [-70.0, 0.01087447121069232, 0.002]
 [-41.16883237123396, 0.011568121230935112, 0.0018320736127034156]
 [-28.580686397587183, 0.012027714615711912, 0.0016925946347780057]
 [-17.206237034780766, 0.01248138637362114, 0.0014938137629492221]
 [-10.034612883824192, 0.012661416557762387, 0.0013213047094854948]
 [-4.926432427074585, 0.012643127924706688, 0.0011815896340838757]
 [-4.926432427074585, 0.012643127924706688, 0.0011815896340838757]
 [11.40616607032275, 0.012388598270653512, 0.0010085513155526204]
 [24.999999999999943, 0.012115952891723136, 0.0009106656472263315]
 [-70.0, 0.012115952891723136, 0.002]
 [-38.72278751820589, 0.012678292164366676, 0.001840837843413631]
 [-27.63529088920452, 0.012949377187142255, 0.0017457143064817861]
 [-12.87897970856585, 0.013308535261717318, 0.0015719712570886116]
 [-3.2861295060023097, 0.013455689461457686, 0.0014373057952382922]
 [9.479586169980147, 0.013460246814174124, 0.0012686146032220022]
 [24.999999999999854, 0.013289478724613868, 0.001125779055956355]
 [-70.0, 0.013289478724613868, 0.002]
 [-38.76406943510368, 0.01375761588350701, 0.0018411590561303005]
 [-29.017480007983693, 0.013946327598093918, 0.0017591714033659226]
 [-14.202976984167984, 0.014213150815553802, 0.0015896736873142515]
 [-5.236404822002717, 0.014294943343929228, 0.0014651100283723894]
 [6.917681982614359, 0.014237802966188545, 0.0012994384896494356]
 [21.01969986266207, 0.014017208612802506, 0.0011554892998294787]
 [24.99999999999983, 0.013951698633446504, 0.001126471506817426]
 [-70.0, 0.013951698633446504, 0.002]
 [-38.884947638568846, 0.014365181651706072, 0.0018420959176590065]
 [-23.967018461081576, 0.01461078847061258, 0.001707721495410653]
 [-9.631492116307813, 0.014772489502886878, 0.001527373406702907]
 [1.8650194689104267, 0.014736531486795705, 0.0013653727656005648]
 [16.7318713488869, 0.014485335555771665, 0.0011926279430315425]
 [24.999999999999865, 0.01432429712299643, 0.0011263286377438185]
 [-70.0, 0.01432429712299643, 0.002]
 [-38.872783329023335, 0.01470855222245159, 0.0018420018843968106]
 [-24.767063238819514, 0.014917906060201377, 0.0017163175400296466]
 [-10.330691326148324, 0.015055345655185326, 0.0015371163220801254]
 [0.733547841549244, 0.015005210703689285, 0.001380881915580867]
 [15.066759526170687, 0.01474367112754966, 0.0012085851606250361]
 [24.999999999999833, 0.014533206792856763, 0.0011260105599959528]
 [-70.0, 0.014533206792856763, 0.002]
 [-38.71911543178162, 0.014903232856754918, 0.0018408092396129884]
 [-25.304793175236263, 0.015090318157717322, 0.0017219445478510336]
 [-10.757732290917325, 0.015215200415895927, 0.0015429836213765892]
 [-0.021875738222002814, 0.015159177384852835, 0.001391305008030617]
 [13.987601002695579, 0.014894260563793999, 0.0012193623204224218]
 [24.99999999999975, 0.014650327814489193, 0.001125845916991905]
 [-70.0, 0.014650327814489193, 0.002]
 [-38.35169585566292, 0.015016340196593538, 0.0018379203036154336]
 [-25.484304080495477, 0.015189117553865575, 0.0017236678896543497]
 [-10.805622986833553, 0.015305515607867724, 0.0015435031158852301]
 [-0.2822981742937446, 0.0152439478864705, 0.0013948041540243672]
 [13.634656932885585, 0.014973588687520818, 0.0012228690394969935]
 [24.999999999999982, 0.014715844215482258, 0.0011257112806978098]
 [-70.0, 0.014715844215482258, 0.002]
 [-38.02206301595578, 0.015081272354765966, 0.001835280185181553]
 [-25.418399406006653, 0.015246567356537547, 0.0017228128799439933]
 [-10.647685814152094, 0.015356179748045002, 0.0015411684625705883]
 [-7.166677231825742, 0.015350105442244024, 0.00149228847069348]</code></pre> <p>Besides the generic <code>plot</code> function, Neuroblox includes some plotting recipes specifically for neuron models. A raster plot with chosen spike threshold</p> <pre><code class="julia hljs">fig = rasterplot(qif, sol; threshold=-<span class=hljs-number >40</span>);
fig</code></pre> <img src="/course/assets/pages/neuron_mass/code/output/qif_raster.svg" alt=""> <p>and a firing rate plot, again by setting the spike threshold and the window size for averaging</p> <pre><code class="julia hljs">fig = frplot(qif, sol; threshold=-<span class=hljs-number >40</span>, win_size=<span class=hljs-number >20</span>);
fig</code></pre> <img src="/course/assets/pages/neuron_mass/code/output/qif_fr.svg" alt=""> <p>We can easily extract the voltage timeseries of neurons by</p> <pre><code class="julia hljs">V = voltage_timeseries(qif, sol) <span class=hljs-comment >## equivalent to `state_timeseries(qif, sol, &quot;V&quot;)`</span>
fig = lines(V);
fig</code></pre> <img src="/course/assets/pages/neuron_mass/code/output/qif_timeseries.svg" alt=""> <p>Finally we simulate an HH neuron with stochastic dynamics which was introduced in <a href="https://doi.org/10.1073/pnas.2120808119">this article on deep brain stimulation int he subthalamic nucleus</a>. The model includes a brownian noise term affecting <code>D&#40;V&#41;</code> which you can inspect using the <code>equations</code> function.</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> StochasticDiffEq <span class=hljs-comment >## to access stochastic DE solvers</span>

<span class=hljs-meta >@named</span> hh = HHNeuronExci_STN_Adam_Blox(; σ=<span class=hljs-number >2</span>) <span class=hljs-comment >## σ is the brownian noise amplitude</span>

sys = system(hh)
prob = SDEProblem(sys, [], (<span class=hljs-number >0</span>, <span class=hljs-number >1000</span>))
sol = solve(prob, RKMil())

<span class=hljs-comment ># Plot the powerspectrum of the solution</span>
fig = powerspectrumplot(hh, sol; samplig_rate=<span class=hljs-number >0.01</span>);
fig</code></pre> <img src="/course/assets/pages/neuron_mass/code/output/hh_power.svg" alt=""> <p>We can use all other plots from above with this stochastic HH neuron since it is a subtype of <code>Neuron</code>. Given its stochastic nature it might be additionally meaningful to show the powerspectrum of its activity.</p> <blockquote> <p><strong><em>Exercise:</em></strong> Try changing the influence of the stochastic term. What do you notice about the powerspectrum of <code>HHNeuronExci_STN_Adam_Blox</code>?</p> </blockquote> <h2 id=sources ><a href="#sources" class=header-anchor >Sources</a></h2> <p>External sources in Neuroblox as a particular Blox subtype &#40;<code>&lt;: AbstractBlox</code>&#41; which contains a system with output and no input variables. Naturally source Bloxs can only connect <strong>to</strong> other &#40;non-source&#41; Blox and can not receive connections from any Blox. There are two main categories of sources, ones with continuous dynamics for their variables and ones that operate through events &#40;callbacks&#41;.</p> <h3 id=continuous_input_sources ><a href="#continuous_input_sources" class=header-anchor >Continuous input sources</a></h3> <p>These sources are comprised of algebraic &#40;and potentially differential&#41; equations that become part of the dynamics of Bloxs that the source connects to. We will drive the <code>WilsonCowan</code> Blox above with a <code>ConstantInput</code> source. The connection between the two Bloxs looks like</p> <pre><code class="julia hljs"><span class=hljs-meta >@named</span> inp = ConstantInput(; I=<span class=hljs-number >3</span>)

connection_rule(inp, nm)</code></pre> <p>This source simply adds a fixed current to the input variable &#40;<code>nm₊jcn</code>&#41; of the downstream &#40;destination&#41; Blox.</p> <pre><code class="julia hljs">g = MetaDiGraph()
add_edge!(g, inp =&gt; nm, weight = <span class=hljs-number >1</span>)

<span class=hljs-meta >@named</span> sys = system_from_graph(g)
prob = ODEProblem(sys, [], tspan)
sol = solve(prob, Tsit5())

fig, ax = plot(sol);
axislegend(ax)
fig</code></pre> <img src="/course/assets/pages/neuron_mass/code/output/wc_input.svg" alt=""> <p>Notice how the E-I balance has shiften after adding our input. We will work with a more complex circuit for E-I balance on the next session and learn more about its intricacies.</p> <p>We can create custom sources with continuous input the same way we create custom Bloxs and write custom connection rules for them as we have seen in the previous session.</p> <h3 id=event-based_spike_sources ><a href="#event-based_spike_sources" class=header-anchor >Event-based spike sources</a></h3> <p>This type of source operates entirely through callbacks. One common example is a source that simulates spiking from presynaptic neurons that we do not explicitly include in our model. Each time the source&#39;s callback is triggered, it affects parameters and/or variables of its postsynaptic neurons which are part of our model. Commonly it is assumed that the spiking of neurons follows a Poisson process. Therefore we have implemented a source in Neuroblox that generates spikes that are distributed according to a Poisson distribution for any finite length of time.</p> <pre><code class="julia hljs">tspan = (<span class=hljs-number >0</span>, <span class=hljs-number >200</span>) <span class=hljs-comment ># ms</span>
spike_rate = <span class=hljs-number >0.01</span> <span class=hljs-comment ># spikes / ms</span>

<span class=hljs-meta >@named</span> spike_train_rate = PoissonSpikeTrain(spike_rate, tspan)</code></pre><pre><code class="plaintext hljs">Neuroblox.PoissonSpikeTrain{Vector{Float64}}(:spike_train_rate, nothing, 1, [0.01], [(0, 200)], 0.01, Random.MersenneTwister(1234))</code></pre>
<p>The <code>PoissonSpikeTrain</code> needs a timespan <code>Tuple</code> &#40;<code>tspan</code>&#41; to generate spikes within it. Above we have set a fixed <code>spike_rate</code> for our process. Alternatively we can also define the spike train with a variable <code>spike_rate</code> that is sampled according to any univariate distribution.</p>
<pre><code class="julia hljs"><span class=hljs-keyword >using</span> Distributions

tspan = (<span class=hljs-number >0</span>, <span class=hljs-number >200</span>) <span class=hljs-comment ># ms</span>
<span class=hljs-comment ># Define a `NamedTuple` holding a `distribution` and a `dt` field</span>
spike_rate = (distibution = Normal(<span class=hljs-number >1</span>, <span class=hljs-number >0.1</span>), dt = <span class=hljs-number >10</span>)

<span class=hljs-meta >@named</span> spike_train_dist = PoissonSpikeTrain(spike_rate, tspan)</code></pre><pre><code class="plaintext hljs">Neuroblox.PoissonSpikeTrain{@NamedTuple{distibution::Distributions.Normal{Float64}, dt::Int64}}(:spike_train_dist, nothing, 1, (distibution = Distributions.Normal{Float64}(μ=1.0, σ=0.1), dt = 10), (0, 200), 0.01, Random.MersenneTwister(1234))</code></pre>
<p>When choosing a variable <code>spike_rate</code> we need to set a <code>dt</code> that dictates how often the <code>distribution</code> will generate a new <code>spike_rate</code> sample. The units of <code>dt</code> match the units of <code>tspan</code> which by default is ms in Neuroblox.</p>
<blockquote>
<p><strong><em>Exercise:</em></strong> Define a <code>LIFExciNeuron</code>, connect a <code>PoissonSpikeTrain</code> to it and tune the source parameters to make the neuron spike. You can visualize spiking using <code>rasterplot</code> and <code>frplot</code> as above.</p>
</blockquote>
<p>We can create custom event-based spike sources with a bit more effort compared to continuous ones. Here is a worked example with comments on the necessary steps :</p>
<pre><code class="julia hljs"><span class=hljs-keyword >struct</span> BernoulliSpikes &lt;: SpikeSource
    name <span class=hljs-comment >## necessary field</span>
    namespace <span class=hljs-comment >## necessary field</span>
    tspan <span class=hljs-comment >## necessary field</span>
    probability_spike
    dt
    <span class=hljs-keyword >function</span> BernoulliSpikes(probability_spike, tspan, dt; name, namespace=<span class=hljs-literal >nothing</span>)
        new(name, namespace, tspan, probability_spike, dt)
    <span class=hljs-keyword >end</span>
<span class=hljs-keyword >end</span>

<span class=hljs-keyword >import</span> Neuroblox: generate_spike_times, connection_spike_affects

<span class=hljs-keyword >function</span> generate_spike_times(source::BernoulliSpikes)
    <span class=hljs-comment ># Write a function that generates and returns a vector of spike times.</span>

    t_range = source.tspan[<span class=hljs-number >1</span>]:source.dt:source.tspan[<span class=hljs-number >2</span>]
    t_spikes = <span class=hljs-built_in >Float64</span>[]
    <span class=hljs-keyword >for</span> t <span class=hljs-keyword >in</span> t_range
        <span class=hljs-keyword >if</span> rand(Bernoulli(source.probability_spike))
            push!(t_spikes, t)
        <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >return</span> t_spikes
<span class=hljs-keyword >end</span>

<span class=hljs-keyword >function</span> connection_spike_affects(source::BernoulliSpikes, ifn::IFNeuron, w)
    <span class=hljs-comment ># Write all equations that should be evaluated each time `source` spikes.</span>
    <span class=hljs-comment ># `w` is the symbolic connection weight, same as in `connection_equations`.</span>

    eqs = [ifn.I_in ~ ifn.I_in + w]
    <span class=hljs-keyword >return</span> eqs
<span class=hljs-keyword >end</span>

tspan = (<span class=hljs-number >0</span>, <span class=hljs-number >500</span>)
<span class=hljs-meta >@named</span> s = BernoulliSpikes(<span class=hljs-number >0.05</span>, tspan, <span class=hljs-number >5</span>)
<span class=hljs-meta >@named</span> ifn = IFNeuron()

g = MetaDiGraph()
add_edge!(g, s =&gt; ifn, weight=<span class=hljs-number >1</span>)
<span class=hljs-meta >@named</span> sys = system_from_graph(g)

prob = ODEProblem(sys, [], tspan)
sol = solve(prob, Tsit5())

fig = rasterplot(ifn, sol);
fig</code></pre>
<img src="/course/assets/pages/neuron_mass/code/output/ifn_input.svg" alt="">
<p>Notice how spikes become more and more frequently over time. Can you tell why this is happening?</p>
<h3 id=deep_brain_stimulation ><a href="#deep_brain_stimulation" class=header-anchor >Deep Brain Stimulation</a></h3>
<p>Neuroblox contains specialized sources that are common to the field of Deep Brain Stimulation &#40;DBS&#41;. These sources simulate stimulation patterns by external probes that are continuous in time, yet contain discrete changes &#40;jumps&#41; on their variables. Even though these sources are often used in DBS protocols, they are implemented as any other source so they can be connected to any other Bloxs given a connection rule. We will first visualize the sources on their own and then connect them to an HH excitatory neuron.</p>
<pre><code class="julia hljs"><span class=hljs-comment ># Set the random seed for reproducible results</span>
<span class=hljs-keyword >using</span> Random
Random.seed!(<span class=hljs-number >1</span>)

<span class=hljs-comment ># Square pulse stimulus</span>
<span class=hljs-meta >@named</span> stim = DBS(
                frequency=<span class=hljs-number >100.0</span>, <span class=hljs-comment >## Hz</span>
                amplitude=<span class=hljs-number >200.0</span>, <span class=hljs-comment >## arbitrary units, depends on how the stimulus is used in the model</span>
                pulse_width=<span class=hljs-number >0.5</span>, <span class=hljs-comment >## ms</span>
                offset=<span class=hljs-number >0.0</span>,
                start_time=<span class=hljs-number >5.0</span>, <span class=hljs-comment >## ms</span>
                smooth=<span class=hljs-number >0.0</span> <span class=hljs-comment >## modulates smoothing effect</span>
);

tspan = (<span class=hljs-number >0</span>, <span class=hljs-number >100</span>) <span class=hljs-comment >## ms</span>
dt = <span class=hljs-number >0.001</span> <span class=hljs-comment >## ms</span>

time = tspan[<span class=hljs-number >1</span>]:dt:tspan[<span class=hljs-number >2</span>]
<span class=hljs-comment ># `stimulus` is a function that is also a field of `DBS` objects.</span>
<span class=hljs-comment ># It turns a time vector into a vector of stimulus values of the same length given the object&#x27;s parameters.</span>
stimulus = stim.stimulus.(time)

fig = Figure();
ax1 = Axis(fig[<span class=hljs-number >1</span>,<span class=hljs-number >1</span>]; xlabel = <span class=hljs-string >&quot;time (ms)&quot;</span>, ylabel = <span class=hljs-string >&quot;stimulus&quot;</span>)
lines!(ax1, time, stimulus)
fig</code></pre>
<img src="/course/assets/pages/neuron_mass/code/output/stim.svg" alt="">
<p>We can also generate a smoothed pulse train as</p>
<pre><code class="julia hljs"><span class=hljs-meta >@named</span> stim_smooth = DBS(
                frequency=<span class=hljs-number >100.0</span>,
                amplitude=<span class=hljs-number >200.0</span>,
                pulse_width=<span class=hljs-number >0.5</span>,
                offset=<span class=hljs-number >0.0</span>,
                start_time=<span class=hljs-number >5.0</span>,
                smooth=<span class=hljs-number >1e-3</span>
);

smooth_stimulus = stim_smooth.stimulus.(time)

fig = Figure();
ax1 = Axis(fig[<span class=hljs-number >1</span>,<span class=hljs-number >1</span>]; xlabel = <span class=hljs-string >&quot;time (ms)&quot;</span>, ylabel = <span class=hljs-string >&quot;stimulus&quot;</span>)
lines!(ax1, time, stimulus) <span class=hljs-comment >## plot the un-smoothed stimulus from above</span>
xlims!(ax1, <span class=hljs-number >4.9</span>, <span class=hljs-number >5.6</span>) <span class=hljs-comment >## set the x-axis limits for better visibility of a smoothed pulse</span>

ax2 = Axis(fig[<span class=hljs-number >2</span>,<span class=hljs-number >1</span>]; xlabel = <span class=hljs-string >&quot;time (ms)&quot;</span>, ylabel = <span class=hljs-string >&quot;stimulus&quot;</span>)
lines!(ax2, time, smooth_stimulus) <span class=hljs-comment >## plot the smoothed stimulus</span>
xlims!(ax2, <span class=hljs-number >4.9</span>, <span class=hljs-number >5.6</span>) <span class=hljs-comment >## set the x-axis limits for better visibility of a smoothed pulse</span>

fig</code></pre>
<img src="/course/assets/pages/neuron_mass/code/output/stim_comparison.svg" alt="">
<p>It is also possible to create a stimulus protocol that does not follow a simple periodic stimulation schedule as above and contains multiple pulses before a quiet time window:</p>
<pre><code class="julia hljs">frequency = <span class=hljs-number >20.0</span>
amplitude = <span class=hljs-number >1.0</span>
pulse_width = <span class=hljs-number >20.0</span>
smooth = <span class=hljs-number >3e-4</span>
pulse_start_time = <span class=hljs-number >0.01</span>
offset = <span class=hljs-number >0</span>
pulses_per_burst = <span class=hljs-number >3</span>
bursts_per_block = <span class=hljs-number >2</span>
pre_block_time = <span class=hljs-number >200.0</span>
inter_burst_time = <span class=hljs-number >200.0</span>

<span class=hljs-meta >@named</span> dbs = ProtocolDBS(
                frequency=frequency,
                amplitude=amplitude,
                pulse_width=pulse_width,
                smooth=smooth,
                offset=offset,
                pulses_per_burst=pulses_per_burst,
                bursts_per_block=bursts_per_block,
                pre_block_time=pre_block_time,
                inter_burst_time=inter_burst_time,
                start_time = pulse_start_time);

t_end = get_protocol_duration(dbs)
t_end = t_end + inter_burst_time
tspan = (<span class=hljs-number >0.0</span>, t_end)
dt = <span class=hljs-number >0.001</span>

time = tspan[<span class=hljs-number >1</span>]:dt:tspan[<span class=hljs-number >2</span>]
stimulus = dbs.stimulus.(time)

fig = Figure();
ax1 = Axis(fig[<span class=hljs-number >1</span>,<span class=hljs-number >1</span>]; xlabel = <span class=hljs-string >&quot;time (ms)&quot;</span>, ylabel = <span class=hljs-string >&quot;stimulus&quot;</span>)
lines!(ax1, time, stimulus)
fig</code></pre>
<img src="/course/assets/pages/neuron_mass/code/output/stim_protocol.svg" alt="">
<p>Now let&#39;s finally connect our <code>ProtocolDBS</code> source to an HH excitatory neuron and simulate</p>
<pre><code class="julia hljs"><span class=hljs-meta >@named</span> nn = HHNeuronExciBlox(I_bg=<span class=hljs-number >0.4</span>)

g = MetaDiGraph()
add_edge!(g, dbs =&gt; nn, weight = <span class=hljs-number >10.0</span>)

<span class=hljs-meta >@named</span> sys = system_from_graph(g)
prob = ODEProblem(sys, [], tspan)

transitions_inds = detect_transitions(time, stimulus; atol=<span class=hljs-number >0.001</span>)
transition_times = time[transitions_inds]
transition_values = stimulus[transitions_inds]
sol = solve(prob, Vern7(), saveat=dt, tstops = transition_times);</code></pre>
<blockquote>
<p><strong><em>NOTE</em>:</strong> We have used <code>detect_transitions</code> to find all points where the stimulation switches on and off. Such points can lead to discontinuities in the dynamics of our model and thus to imprecise solutions. Adding the transition points explicitly as <code>tstops</code> when solving will force the chosen solver to stop righ before and after each transition and evaluate the equations for greater precision and stability.</p>
</blockquote>
<pre><code class="julia hljs"><span class=hljs-comment ># Retrive the timeseries of the voltage variable (`nn₊V`) from the solution</span>
v = voltage_timeseries(nn, sol)

<span class=hljs-comment ># Plot the voltage and stimulation timeseries on two axes on the same window.</span>
fig = Figure();
ax1 = Axis(fig[<span class=hljs-number >1</span>,<span class=hljs-number >1</span>]; xlabel = <span class=hljs-string >&quot;time (ms)&quot;</span>, ylabel = <span class=hljs-string >&quot;Voltage (mV)&quot;</span>)
lines!(ax1, sol.t, v)

ax2 = Axis(fig[<span class=hljs-number >2</span>,<span class=hljs-number >1</span>]; xlabel = <span class=hljs-string >&quot;time (ms)&quot;</span>, ylabel = <span class=hljs-string >&quot;Stimulus (μA/cm²)&quot;</span>)
lines!(ax2, sol.t, stimulus)
fig</code></pre>
<img src="/course/assets/pages/neuron_mass/code/output/stim_hh.svg" alt="">
<h2 id=challenge_problems ><a href="#challenge_problems" class=header-anchor >Challenge Problems</a></h2>
<ul>
<li><p>Implement a custom <code>SpikeSource</code> of your choice. Hint: the <code>BernoulliSpikes</code> implementation above.</p>

<li><p>Write a function that plots the <a href="https://en.wikipedia.org/wiki/F-I_curve">f-I curve</a> of a Blox. Hint: Consider a <code>ContantInput</code> source to vary input currents and <code>firing_rate&#40;blox, solution; threshold&#61;...&#41;</code> to calculate firing rates.</p>

<li><p>Write a function that plots the <a href="https://en.wikipedia.org/wiki/Peristimulus_time_histogram">Peristimulus time histogram</a> of a Blox around a given timepoint. Hint: use the <code>hist</code> or <code>barplot</code> plotting functions from <code>Makie</code> and <code>detect_spikes&#40;blox, solution; threshold&#61;...&#41;</code> to find spikes.</p>

</ul>
<h2 id=references ><a href="#references" class=header-anchor >References</a></h2>
<ul>
<li><p>&#91;1&#93; Gerstner W, Kistler WM, Naud R, Paninski L. Neuronal Dynamics: From Single Neurons to Networks and Models of Cognition, Parts I &amp; II. Cambridge University Press; 2014.</p>

<li><p>&#91;2&#93; Adam, Elie M., et al. &quot;Deep brain stimulation in the subthalamic nucleus for Parkinson&#39;s disease can restore dynamics of striatal networks.&quot; Proceedings of the National Academy of Sciences 119.19 &#40;2022&#41;: e2120808119.</p>

</ul>

<div class=page-foot >
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> Neuroblox Inc. Last modified: January 03, 2025.
    Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
</div>
</div>
  </main> 
  <script src="/course/libs/vela/metisMenu.min.js"></script>
  <script src="/course/libs/vela/slideout.min.js"></script>
  
  
    <script src="/course/libs/highlight/highlight.min.js"></script>
<script>hljs.highlightAll();hljs.configure({tabReplace: '    '});</script>